<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>집안일매니저</title>
    <!-- Google Sign-In API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- 이미지 관리 파일 -->
    <script src="images.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', '굴림체', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* 헤더 */
        .header {
            background: linear-gradient(135deg, rgb(95, 240, 167) 0%, rgb(82, 135, 250) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header .user-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* 네비게이션 */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 80px;
            z-index: 99;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: rgb(82, 135, 250);
            border-bottom: 2px solid rgb(82, 135, 250);
            font-weight: bold;
        }

        /* 메인 컨텐츠 */
        .content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 오늘 할 일 섹션 */
        .today-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.3s ease;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item.completed {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .task-item.in-progress {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .task-checkbox.completed {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .task-checkbox.in-progress {
            background-color: #ffc107;
            border-color: #ffc107;
            color: white;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .task-meta {
            font-size: 0.8rem;
            color: #666;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .priority-red { background-color: #dc3545; }
        .priority-blue { background-color: rgb(82, 135, 250); }
        .priority-green { background-color: rgb(95, 240, 167); }
        .priority-gray { background-color: #6c757d; }
        .priority-black { background-color: #000000; }

        /* 할 일 관리 섹션 */
        .task-management {
            margin-bottom: 20px;
        }

        .task-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, rgb(95, 240, 167) 0%, rgb(82, 135, 250) 100%);
            color: white;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* 조개 보상 섹션 */
        .reward-section {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .shell-count {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .shell-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        /* 가족 관리 섹션 */
        .family-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .family-member {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .family-member:last-child {
            border-bottom: none;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgb(95, 240, 167) 0%, rgb(82, 135, 250) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .member-tasks {
            font-size: 0.8rem;
            color: #666;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* 폼 스타일 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        /* 반응형 */
        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .content {
                padding: 15px;
            }
            
            .task-controls {
                flex-direction: column;
            }
        }

        /* 로딩 애니메이션 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid rgb(82, 135, 250);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 랜딩페이지 스타일 */
        .landing-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .landing-content {
            text-align: center;
            max-width: 500px;
            padding: 40px 20px;
        }

        .app-logo h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #2563EB;
            font-weight: 700;
            letter-spacing: -2px;
            white-space: nowrap;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .app-description {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 40px;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 50px;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1rem;
            min-width: 200px;
        }

        .btn-google {
            background: white;
            color: #333;
            border: 1px solid #dadce0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-google:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-apple {
            background: #000;
            color: white;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-apple:hover {
            background: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn-icon {
            width: 20px;
            height: 20px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 30px;
        }

        .feature-item {
            background: white;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            text-align: center;
        }

        .feature-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .feature-icon {
            margin-bottom: 12px;
            color: rgb(82, 135, 250);
        }

        .feature-icon svg {
            width: 40px;
            height: 40px;
        }

        .feature-item h3 {
            font-size: 0.95rem;
            margin: 0;
            color: #333;
            font-weight: 600;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* 로그인/회원가입 모달 스타일 */
        .auth-modal .modal-content {
            max-width: 400px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            color: rgb(82, 135, 250);
            border-bottom-color: rgb(82, 135, 250);
            font-weight: bold;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .features {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 769px) {
            .auth-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .app-logo h1 {
                font-size: 2rem;
                letter-spacing: -0.5px;
            }

            .features {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .feature-item {
                padding: 15px 10px;
            }

            .feature-icon svg {
                width: 32px;
                height: 32px;
            }

            .feature-item h3 {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 랜딩페이지 -->
        <div id="landingPage" class="landing-page">
            <div class="landing-content">
                <div class="app-logo">
                    <h1>🏠 집안일매니저</h1>
                    <p class="app-description">가족과 함께하는 스마트한 집안일 관리</p>
                </div>
                
                <div class="auth-buttons">
                    <button class="btn btn-google btn-large" onclick="loginWithGoogle()">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google로 계속하기
                    </button>
                    <button class="btn btn-apple btn-large" onclick="loginWithApple()">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20">
                            <path fill="#000" d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.11-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                        </svg>
                        Apple로 계속하기
                    </button>
                </div>
                
                <div class="features">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <h3>주기별 할일</h3>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <h3>가사 분담</h3>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <h3>보상 시스템</h3>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <h3>알람 기능</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메인 애플리케이션 (로그인 후 표시) -->
        <div id="mainApp" class="main-app" style="display: none;">
            <!-- 헤더 -->
            <div class="header">
                <h1>🏠 집안일매니저</h1>
                <div class="user-info">
                    <span id="familyGroup">[가족그룹명]</span>의 <span id="userNickname">[닉네임]</span>
                    <button class="btn btn-small" onclick="logout()" style="margin-left: 10px;">로그아웃</button>
                </div>
            </div>

            <!-- 네비게이션 탭 -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('today')">오늘 할 일</button>
                <button class="nav-tab" onclick="showTab('manage')">내일 할일</button>
                <button class="nav-tab" onclick="showTab('reward')">나의 조개</button>
                <button class="nav-tab" onclick="showTab('family')">가족 관리</button>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="content">
            <!-- 오늘 할 일 탭 -->
            <div id="today" class="tab-content active">
                <div class="today-section">
                    <h2 class="section-title">
                        📋 오늘 할 일 리스트
                        <span style="font-size: 0.8rem; color: #666; font-weight: normal;">
                            (<span id="todayDate"></span>)
                        </span>
                    </h2>
                    <div class="task-list" id="todayTaskList">
                        <div class="loading">
                            <div class="spinner"></div>
                            할 일을 불러오는 중...
                        </div>
                    </div>
                </div>

                <div class="today-section">
                    <h2 class="section-title">📅 내일 할 일 계획</h2>
                    <div class="task-list" id="tomorrowTaskList">
                        <div class="loading">
                            <div class="spinner"></div>
                            할 일을 불러오는 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 내일 할일 탭 -->
            <div id="manage" class="tab-content">
                <div class="task-management">
                    <h2 class="section-title">📅 내일 할일</h2>
                    
                    <div class="task-controls">
                        <button class="btn btn-primary" onclick="openAddTaskModal()">
                            ➕ 새로운 할 일 추가
                        </button>
                        <button class="btn btn-secondary" onclick="openTemplateModal()">
                            📋 템플릿 추가
                        </button>
                    </div>

                    <div class="task-list" id="allTaskList">
                        <div class="loading">
                            <div class="spinner"></div>
                            할 일을 불러오는 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 나의 조개 탭 -->
            <div id="reward" class="tab-content">
                <div class="reward-section">
                    <div class="shell-icon">🐚</div>
                    <div class="shell-count" id="shellCount">0</div>
                    <p>나의 조개</p>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                        할 일을 완료할 때마다 조개를 획득합니다!
                    </p>
                </div>

                <div class="task-list">
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-name">오늘 완료한 할 일</div>
                            <div class="task-meta" id="todayCompletedCount">0개</div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-name">이번 주 완료한 할 일</div>
                            <div class="task-meta" id="weekCompletedCount">0개</div>
                        </div>
                    </div>
                    <div class="task-item">
                        <div class="task-info">
                            <div class="task-name">이번 달 완료한 할 일</div>
                            <div class="task-meta" id="monthCompletedCount">0개</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 가족 관리 탭 -->
            <div id="family" class="tab-content">
                <div class="task-management">
                    <h2 class="section-title">👨‍👩‍👧‍👦 가족 관리</h2>
                    
                    <div class="task-controls">
                        <button class="btn btn-primary" onclick="openInviteModal()">
                            📱 가족 초대
                        </button>
                        <button class="btn btn-secondary" onclick="openAlarmModal()">
                            🔔 알람 설정
                        </button>
                    </div>

                    <div class="family-list" id="familyList">
                        <div class="loading">
                            <div class="spinner"></div>
                            가족 정보를 불러오는 중...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 할 일 추가 모달 -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">새로운 할 일 추가</h3>
                <button class="close-btn" onclick="closeModal('addTaskModal')">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label class="form-label">할 일 이름</label>
                    <input type="text" class="form-input" id="taskName" placeholder="예: 설거지, 바닥청소 등" required>
                </div>
                <div class="form-group">
                    <label class="form-label">카테고리</label>
                    <select class="form-select" id="taskCategory" required>
                        <option value="">선택하세요</option>
                        <!-- 카테고리는 동적으로 로드됩니다 -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">주기</label>
                    <select class="form-select" id="taskCycle" required onchange="handleCycleChange()">
                        <option value="">선택하세요</option>
                        <option value="custom_days">며칠마다</option>
                        <option value="custom_weeks">몇주마다</option>
                    </select>
                </div>
                
                <!-- 커스텀 주기 입력 -->
                <div class="form-group" id="customCycleGroup" style="display: none;">
                    <label class="form-label" id="customCycleLabel">간격</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" class="form-input" id="customCycleValue" min="1" max="6" style="width: 80px;">
                        <span id="customCycleUnit">일</span>
                    </div>
                    <div class="task-meta" id="customCycleHint" style="margin-top: 5px; color: #666;">
                        1일부터 6일까지 입력 가능합니다.
                    </div>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">추가하기</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTaskModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 가족 초대 모달 -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">가족 초대</h3>
                <button class="close-btn" onclick="closeModal('inviteModal')">&times;</button>
            </div>
            <form id="inviteForm">
                <div class="form-group">
                    <label class="form-label">핸드폰 번호</label>
                    <input type="tel" class="form-input" id="invitePhone" placeholder="010-1234-5678" required>
                </div>
                <div class="form-group">
                    <label class="form-label">가족 내 닉네임</label>
                    <input type="text" class="form-input" id="inviteNickname" placeholder="예: 엄마, 아빠, 형 등" required>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">초대 메시지 전송</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inviteModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 알람 설정 모달 -->
    <div id="alarmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">알람 설정</h3>
                <button class="close-btn" onclick="closeModal('alarmModal')">&times;</button>
            </div>
            <form id="alarmForm">
                <div class="form-group">
                    <label class="form-label">알람 시간</label>
                    <input type="time" class="form-input" id="alarmTime" required>
                </div>
                <div class="form-group">
                    <label class="form-label">알람 요일</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label><input type="checkbox" value="mon"> 월</label>
                        <label><input type="checkbox" value="tue"> 화</label>
                        <label><input type="checkbox" value="wed"> 수</label>
                        <label><input type="checkbox" value="thu"> 목</label>
                        <label><input type="checkbox" value="fri"> 금</label>
                        <label><input type="checkbox" value="sat"> 토</label>
                        <label><input type="checkbox" value="sun"> 일</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">알람 방식</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label><input type="checkbox" value="app"> 앱 푸시</label>
                        <label><input type="checkbox" value="kakao"> 카톡 전송</label>
                    </div>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">설정 저장</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('alarmModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 템플릿 추가 모달 -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">할 일 템플릿 추가</h3>
                <button class="close-btn" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <form id="templateForm">
                <div class="form-group">
                    <label class="form-label">주기 선택</label>
                    <select class="form-select" id="templateCycle" required onchange="loadTemplateTasks()">
                        <option value="">선택하세요</option>
                        <option value="daily">매일</option>
                        <option value="weekly">매주</option>
                        <option value="monthly">4주</option>
                        <option value="quarterly">12주</option>
                        <option value="yearly">52주</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">추가할 할 일들</label>
                    <div id="templateTaskList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <p style="color: #666; text-align: center; margin: 20px 0;">주기를 선택해주세요</p>
                    </div>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">템플릿 추가</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 로그인/회원가입 모달 -->
    <div id="authModal" class="modal auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">집안일매니저</h3>
                <button class="close-btn" onclick="closeModal('authModal')">&times;</button>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">로그인</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">회원가입</button>
            </div>

            <!-- 로그인 폼 -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label class="form-label">이메일</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="이메일을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label class="form-label">비밀번호</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="비밀번호를 입력하세요" required>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">로그인</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('authModal')">취소</button>
                </div>
            </form>

            <!-- 회원가입 폼 -->
            <form id="signupForm" class="auth-form">
                <div class="form-group">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-input" id="signupName" placeholder="이름을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label class="form-label">이메일</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="이메일을 입력하세요" required>
                </div>
                <div class="form-group">
                    <label class="form-label">전화번호</label>
                    <input type="tel" class="form-input" id="signupPhone" placeholder="010-1234-5678" required>
                </div>
                <div class="form-group">
                    <label class="form-label">비밀번호</label>
                    <input type="password" class="form-input" id="signupPassword" placeholder="비밀번호를 입력하세요" required>
                </div>
                <div class="form-group">
                    <label class="form-label">비밀번호 확인</label>
                    <input type="password" class="form-input" id="signupPasswordConfirm" placeholder="비밀번호를 다시 입력하세요" required>
                </div>
                <div class="form-group">
                    <label class="form-label">가족 내 닉네임</label>
                    <input type="text" class="form-input" id="signupNickname" placeholder="예: 아빠, 엄마, 형 등" required>
                </div>
                <div class="task-controls">
                    <button type="submit" class="btn btn-primary">회원가입</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('authModal')">취소</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentUser = {
            id: 'USER001',
            name: '사용자',
            nickname: '닉네임',
            familyGroup: '우리가족',
            shellCount: 0
        };

        let tasks = [];
        let familyMembers = [];
        
        // Google Apps Script 웹앱 URL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwn7CcOHVPnrF0JgS-COcyaFtwPB_Pm-tEYy-6ME1YLzZpxh2piquspKJhDwac61XdFZg/exec';

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 앱 초기화
        function initializeApp() {
            // Google Sign-In 초기화
            setTimeout(() => {
                initializeGoogleSignIn();
            }, 1000);
            
            // OAuth 콜백 처리
            handleOAuthCallback();
            
            // 로그인 상태 확인
            checkLoginStatus();
            
            // 폼 이벤트 리스너 등록
            document.getElementById('addTaskForm').addEventListener('submit', handleAddTask);
            document.getElementById('inviteForm').addEventListener('submit', handleInvite);
            document.getElementById('alarmForm').addEventListener('submit', handleAlarmSetting);
            document.getElementById('templateForm').addEventListener('submit', handleTemplateAdd);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
        }

        // 로그인 상태 확인
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const savedUser = localStorage.getItem('currentUser');
            
            if (isLoggedIn && savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
                loadAppData();
            } else {
                showLandingPage();
            }
        }

        // 랜딩페이지 표시
        function showLandingPage() {
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        // 메인 앱 표시
        function showMainApp() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadAppData();
        }

        // 앱 데이터 로드
        function loadAppData() {
            updateUserInfo();
            updateTodayDate();
            loadTasks();
            loadFamilyMembers();
            loadShellCount();
            loadCategories();
        }

        // 사용자 정보 업데이트
        function updateUserInfo() {
            document.getElementById('familyGroup').textContent = currentUser.familyGroup;
            document.getElementById('userNickname').textContent = currentUser.nickname;
        }

        // 오늘 날짜 업데이트
        function updateTodayDate() {
            const today = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('ko-KR', options);
        }

        // 탭 전환
        function showTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // 탭별 데이터 로드
            switch(tabName) {
                case 'today':
                    loadTodayTasks();
                    break;
                case 'manage':
                    loadAllTasks();
                    break;
                case 'reward':
                    loadRewardData();
                    break;
                case 'family':
                    loadFamilyData();
                    break;
            }
        }

        // Google Apps Script API 호출 함수
        async function callGAS(action, data = {}) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || '서버 오류가 발생했습니다.');
                }
                
                return result.data;
            } catch (error) {
                console.error('GAS API 호출 오류:', error);
                // 오프라인 모드나 개발 모드에서는 샘플 데이터 사용
                return getSampleData(action, data);
            }
        }

        // 샘플 데이터 반환 (개발/오프라인용)
        function getSampleData(action, data) {
            switch(action) {
                case 'getTasks':
                    return [
                        {
                            task_id: 'CHORE001',
                            task_name: '설거지',
                            category: '주방',
                            cycle: 'daily',
                            assignee_id: 'IDF001-01',
                            last_date: '2024-09-29',
                            next_date: '2024-09-30',
                            status: 'todo',
                            priority: 'red',
                            created_at: new Date().toISOString()
                        },
                        {
                            task_id: 'CHORE002',
                            task_name: '바닥청소',
                            category: '거실',
                            cycle: 'daily',
                            assignee_id: 'IDF001-01',
                            last_date: '2024-09-29',
                            next_date: '2024-09-30',
                            status: 'todo',
                            priority: 'red',
                            created_at: new Date().toISOString()
                        },
                        {
                            task_id: 'CHORE003',
                            task_name: '화장실 청소',
                            category: '화장실',
                            cycle: 'weekly',
                            assignee_id: 'IDF001-01',
                            last_date: '2024-09-23',
                            next_date: '2024-09-30',
                            status: 'todo',
                            priority: 'blue',
                            created_at: new Date().toISOString()
                        },
                        {
                            task_id: 'CHORE004',
                            task_name: '베란다 정리',
                            category: '베란다',
                            cycle: 'weekly',
                            assignee_id: 'IDF001-02',
                            last_date: '2024-09-23',
                            next_date: '2024-09-30',
                            status: 'todo',
                            priority: 'green',
                            created_at: new Date().toISOString()
                        },
                        {
                            task_id: 'CHORE005',
                            task_name: '차량 세차',
                            category: '차',
                            cycle: 'custom_weeks_2',
                            assignee_id: 'IDF001-02',
                            last_date: '2024-09-16',
                            next_date: '2024-10-01',
                            status: 'todo',
                            priority: 'black',
                            created_at: new Date().toISOString()
                        }
                    ];
                case 'getFamilyMembers':
                    return [
                        { user_id: 'USER001', name: '김철수', nickname: '아빠', phone: '010-1234-5678', shell_count: 15 },
                        { user_id: 'USER002', name: '김영희', nickname: '엄마', phone: '010-2345-6789', shell_count: 20 }
                    ];
                case 'getUserInfo':
                    return {
                        user_id: 'USER001',
                        name: '김철수',
                        family_id: 'FAMILY001',
                        shell_person: 15
                    };
                case 'getCategories':
                    return ['주방', '거실', '안방', '다른방', '화장실', '베란다', '현관', '자동차', '강아지', '정원', '계절', '기타'];
                default:
                    return null;
            }
        }

        // 할 일 데이터 로드
        async function loadTasks() {
            try {
                const taskData = await callGAS('getTasks', { userId: currentUser.id });
                tasks = taskData.map(task => ({
                    id: task.task_id,
                    name: task.task_name,
                    category: task.category,
                    cycle: task.cycle,
                    assignee: task.assignee_id,
                    lastDate: task.last_date,
                    nextDate: task.next_date,
                    status: task.status,
                    priority: task.priority,
                    createdAt: task.created_at
                }));
            } catch (error) {
                console.error('할 일 로드 오류:', error);
                // 오류 시 빈 배열로 초기화
                tasks = [];
            }
        }

        // 오늘 할 일 로드
        function loadTodayTasks() {
            const todayTasks = tasks.filter(task => {
                const today = new Date().toISOString().split('T')[0];
                return task.nextDate === today || task.status === 'in-progress';
            });

            const todayTaskList = document.getElementById('todayTaskList');
            todayTaskList.innerHTML = '';

            if (todayTasks.length === 0) {
                todayTaskList.innerHTML = '<div class="task-item"><div class="task-info">오늘 할 일이 없습니다! 🎉</div></div>';
                return;
            }

            todayTasks.forEach(task => {
                const taskElement = createTaskElement(task, true);
                todayTaskList.appendChild(taskElement);
            });

            // 내일 할 일도 로드
            loadTomorrowTasks();
        }

        // 내일 할 일 로드
        function loadTomorrowTasks() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toISOString().split('T')[0];

            const tomorrowTasks = tasks.filter(task => {
                return task.nextDate === tomorrowDate || task.priority === 'red';
            });

            const tomorrowTaskList = document.getElementById('tomorrowTaskList');
            tomorrowTaskList.innerHTML = '';

            if (tomorrowTasks.length === 0) {
                tomorrowTaskList.innerHTML = '<div class="task-item"><div class="task-info">내일 할 일이 없습니다!</div></div>';
                return;
            }

            // 우선순위별 정렬 (빨강 > 파랑 > 초록 > 회색)
            const priorityOrder = { 'red': 1, 'blue': 2, 'green': 3, 'gray': 4 };
            tomorrowTasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            tomorrowTasks.forEach(task => {
                const taskElement = createTaskElement(task, false);
                tomorrowTaskList.appendChild(taskElement);
            });
        }

        // 모든 할 일 로드
        function loadAllTasks() {
            const allTaskList = document.getElementById('allTaskList');
            allTaskList.innerHTML = '';

            tasks.forEach(task => {
                const taskElement = createTaskElement(task, false, true);
                allTaskList.appendChild(taskElement);
            });
        }

        // 할 일 요소 생성
        function createTaskElement(task, isToday = false, showManage = false) {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item ${task.status === 'completed' ? 'completed' : ''} ${task.status === 'in-progress' ? 'in-progress' : ''}`;

            const checkbox = document.createElement('div');
            checkbox.className = `task-checkbox ${task.status}`;
            checkbox.onclick = () => toggleTaskStatus(task.id);
            
            if (task.status === 'completed') {
                checkbox.innerHTML = '✓';
            } else if (task.status === 'in-progress') {
                checkbox.innerHTML = '⏳';
            }

            const taskInfo = document.createElement('div');
            taskInfo.className = 'task-info';
            
            const taskName = document.createElement('div');
            taskName.className = 'task-name';
            taskName.textContent = task.name;
            
            const taskMeta = document.createElement('div');
            taskMeta.className = 'task-meta';
            taskMeta.textContent = `${task.category} • ${getCycleText(task.cycle)} • 다음: ${task.nextDate}`;
            
            taskInfo.appendChild(taskName);
            taskInfo.appendChild(taskMeta);

            const priority = document.createElement('div');
            priority.className = `task-priority priority-${task.priority}`;

            taskItem.appendChild(checkbox);
            taskItem.appendChild(taskInfo);
            taskItem.appendChild(priority);

            if (showManage) {
                const manageBtn = document.createElement('button');
                manageBtn.className = 'btn btn-secondary';
                manageBtn.style.marginLeft = '10px';
                manageBtn.style.padding = '5px 10px';
                manageBtn.textContent = '수정';
                manageBtn.onclick = () => editTask(task.id);
                taskItem.appendChild(manageBtn);
            }

            return taskItem;
        }

        // 할 일 상태 토글
        async function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            let newStatus;
            // 상태 순환: todo -> in-progress -> completed -> todo
            switch(task.status) {
                case 'todo':
                    newStatus = 'in-progress';
                    break;
                case 'in-progress':
                    newStatus = 'completed';
                    break;
                case 'completed':
                    newStatus = 'todo';
                    break;
                default:
                    newStatus = 'todo';
            }

            try {
                // 서버에 상태 업데이트 요청
                await callGAS('updateTask', {
                    task_id: taskId,
                    status: newStatus,
                    assignee_id: task.assignee
                });

                // 로컬 상태 업데이트
                task.status = newStatus;

                // 완료 시 다음 날짜 계산
                if (newStatus === 'completed') {
                    updateNextDate(task);
                    currentUser.shellCount++;
                } else if (task.status === 'completed' && newStatus !== 'completed') {
                    currentUser.shellCount = Math.max(0, currentUser.shellCount - 1);
                }

                // UI 업데이트
                loadTodayTasks();
                updateShellCount();
            } catch (error) {
                console.error('할 일 상태 업데이트 오류:', error);
                alert('상태 업데이트 중 오류가 발생했습니다.');
            }
        }

        // 다음 날짜 계산
        function updateNextDate(task) {
            const lastDate = new Date(task.lastDate);
            let nextDate = new Date(lastDate);

            // 커스텀 주기 처리
            if (task.cycle && task.cycle.includes('custom_days_')) {
                const days = parseInt(task.cycle.split('_')[2]);
                nextDate.setDate(nextDate.getDate() + days);
            } else if (task.cycle && task.cycle.includes('custom_weeks_')) {
                const weeks = parseInt(task.cycle.split('_')[2]);
                nextDate.setDate(nextDate.getDate() + (weeks * 7));
            } else {
                switch(task.cycle) {
                    case 'daily':
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        nextDate.setMonth(nextDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                        break;
                }
            }

            task.lastDate = new Date().toISOString().split('T')[0];
            task.nextDate = nextDate.toISOString().split('T')[0];
        }

        // 주기 선택 변경 핸들러
        function handleCycleChange() {
            const cycleSelect = document.getElementById('taskCycle');
            const customGroup = document.getElementById('customCycleGroup');
            const customLabel = document.getElementById('customCycleLabel');
            const customUnit = document.getElementById('customCycleUnit');
            const customHint = document.getElementById('customCycleHint');
            const customInput = document.getElementById('customCycleValue');
            
            if (cycleSelect.value === 'custom_days') {
                customGroup.style.display = 'block';
                customLabel.textContent = '며칠마다';
                customUnit.textContent = '일';
                customHint.textContent = '1일부터 6일까지 입력 가능합니다.';
                customInput.min = 1;
                customInput.max = 6;
                customInput.value = '';
            } else if (cycleSelect.value === 'custom_weeks') {
                customGroup.style.display = 'block';
                customLabel.textContent = '몇주마다';
                customUnit.textContent = '주';
                customHint.textContent = '1주부터 52주까지 입력 가능합니다.';
                customInput.min = 1;
                customInput.max = 52;
                customInput.value = '';
            } else {
                customGroup.style.display = 'none';
                customInput.value = '';
            }
        }

        // 주기 텍스트 변환
        function getCycleText(cycle) {
            const cycleMap = {
                'daily': '매일',
                'weekly': '매주',
                'monthly': '매달',
                'quarterly': '분기',
                'yearly': '매년'
            };
            
            // 커스텀 주기 처리
            if (cycle && cycle.includes('custom_')) {
                const parts = cycle.split('_');
                if (parts.length === 3) {
                    const value = parts[2];
                    const unit = parts[1] === 'days' ? '일마다' : '주마다';
                    return `${value}${unit}`;
                }
            }
            
            return cycleMap[cycle] || cycle;
        }

        // 카테고리 로드
        async function loadCategories() {
            console.log('카테고리 로드 시작...');
            try {
                const categories = await callGAS('getCategories');
                console.log('로드된 카테고리:', categories);
                
                const categorySelect = document.getElementById('taskCategory');
                if (!categorySelect) {
                    console.error('taskCategory 선택 요소를 찾을 수 없습니다.');
                    return;
                }
                
                // 기존 옵션 제거 (첫 번째 선택 옵션 제외)
                categorySelect.innerHTML = '<option value="">선택하세요</option>';
                
                // 카테고리 옵션 추가
                if (Array.isArray(categories) && categories.length > 0) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                    console.log('카테고리 옵션 추가 완료:', categories.length + '개');
                } else {
                    console.warn('카테고리 데이터가 비어있습니다.');
                    loadDefaultCategories(categorySelect);
                }
            } catch (error) {
                console.error('카테고리 로드 오류:', error);
                const categorySelect = document.getElementById('taskCategory');
                loadDefaultCategories(categorySelect);
            }
        }

        // 기본 카테고리 로드
        function loadDefaultCategories(categorySelect) {
            const defaultCategories = ['주방', '거실', '화장실', '베란다', '방', '차', '창문', '계절', '기타'];
            console.log('기본 카테고리 사용:', defaultCategories);
            
            categorySelect.innerHTML = '<option value="">선택하세요</option>';
            defaultCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // 가족 구성원 로드
        async function loadFamilyMembers() {
            try {
                const userInfo = await callGAS('getUserInfo', { userId: currentUser.id });
                const familyData = await callGAS('getFamilyMembers', { familyId: userInfo.family_id });
                
                familyMembers = familyData.map(member => ({
                    id: member.user_id,
                    name: member.name,
                    nickname: member.nickname,
                    phone: member.phone,
                    shellCount: member.shell_count || 0
                }));
            } catch (error) {
                console.error('가족 구성원 로드 오류:', error);
                // 오류 시 샘플 데이터 사용
                familyMembers = getSampleData('getFamilyMembers');
            }
        }

        // 가족 데이터 로드
        function loadFamilyData() {
            const familyList = document.getElementById('familyList');
            familyList.innerHTML = '';

            familyMembers.forEach(member => {
                const memberTasks = tasks.filter(task => task.assignee === member.id);
                const completedTasks = memberTasks.filter(task => task.status === 'completed').length;

                const memberElement = document.createElement('div');
                memberElement.className = 'family-member';

                memberElement.innerHTML = `
                    <div class="member-avatar">${member.nickname.charAt(0)}</div>
                    <div class="member-info">
                        <div class="member-name">${member.nickname}</div>
                        <div class="member-tasks">할당된 할 일: ${memberTasks.length}개 • 완료: ${completedTasks}개</div>
                    </div>
                `;

                familyList.appendChild(memberElement);
            });
        }

        // 조개 개수 로드
        function loadShellCount() {
            updateShellCount();
        }

        // 조개 개수 업데이트
        function updateShellCount() {
            document.getElementById('shellCount').textContent = currentUser.shellCount;
        }

        // 보상 데이터 로드
        function loadRewardData() {
            updateShellCount();
            
            // 완료 통계 계산
            const today = new Date().toISOString().split('T')[0];
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
            const thisMonthStart = new Date();
            thisMonthStart.setDate(1);

            const todayCompleted = tasks.filter(task => 
                task.status === 'completed' && task.lastDate === today
            ).length;

            const weekCompleted = tasks.filter(task => 
                task.status === 'completed' && new Date(task.lastDate) >= thisWeekStart
            ).length;

            const monthCompleted = tasks.filter(task => 
                task.status === 'completed' && new Date(task.lastDate) >= thisMonthStart
            ).length;

            document.getElementById('todayCompletedCount').textContent = `${todayCompleted}개`;
            document.getElementById('weekCompletedCount').textContent = `${weekCompleted}개`;
            document.getElementById('monthCompletedCount').textContent = `${monthCompleted}개`;
        }

        // 모달 열기
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
            // 모달이 열릴 때 주기 선택을 초기화
            document.getElementById('customCycleGroup').style.display = 'none';
            // 카테고리 다시 로드
            loadCategories();
        }

        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
            // 모달이 열릴 때 초기화
            document.getElementById('templateCycle').value = '';
            document.getElementById('templateTaskList').innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">주기를 선택해주세요</p>';
        }

        // openScheduleModal 함수 제거

        function openInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
        }

        function openAlarmModal() {
            document.getElementById('alarmModal').classList.add('active');
        }

        // 모달 닫기
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // 할 일 추가 처리
        async function handleAddTask(event) {
            event.preventDefault();
            
            const taskName = document.getElementById('taskName').value;
            const taskCategory = document.getElementById('taskCategory').value;
            const taskCycleSelect = document.getElementById('taskCycle').value;
            
            // 커스텀 주기 처리
            let finalCycle = taskCycleSelect;
            if (taskCycleSelect === 'custom_days' || taskCycleSelect === 'custom_weeks') {
                const customValue = document.getElementById('customCycleValue').value;
                
                if (!customValue) {
                    alert('주기 간격을 입력해주세요.');
                    return;
                }
                
                // 입력값 검증
                const value = parseInt(customValue);
                if (taskCycleSelect === 'custom_days' && (value < 1 || value > 6)) {
                    alert('며칠마다는 1일부터 6일까지만 입력 가능합니다.');
                    return;
                }
                if (taskCycleSelect === 'custom_weeks' && (value < 1 || value > 52)) {
                    alert('몇주마다는 1주부터 52주까지만 입력 가능합니다.');
                    return;
                }
                
                finalCycle = `${taskCycleSelect}_${customValue}`;
            }

            try {
                const userInfo = await callGAS('getUserInfo', { userId: currentUser.id });
                const familyMember = await callGAS('getFamilyMemberByUserId', { userId: currentUser.id });
                
                const newTaskData = {
                    task_name: taskName,
                    category: taskCategory,
                    choregroup_name: taskCategory, // choregroup_name
                    cycle: finalCycle,
                    assignee_id: familyMember ? familyMember.id_infamily : currentUser.id, // 가족 구성원 ID 사용
                    family_id: userInfo.family_id,
                    status: 'todo',
                    priority: 'gray',
                    freq_type: finalCycle.includes('days') ? 'day' : 'week',
                    freq_value: finalCycle.includes('custom_') ? parseInt(finalCycle.split('_')[2]) : 1
                };

                await callGAS('addTask', newTaskData);
                
                // 할 일 목록 새로고침
                await loadTasks();
                
                // 폼 초기화
                document.getElementById('addTaskForm').reset();
                document.getElementById('customCycleGroup').style.display = 'none';
                closeModal('addTaskModal');
                
                // UI 업데이트
                loadTodayTasks();
                loadAllTasks();
                
                alert('새로운 할 일이 추가되었습니다!');
            } catch (error) {
                console.error('할 일 추가 오류:', error);
                alert('할 일 추가 중 오류가 발생했습니다.');
            }
        }

        // 다음 날짜 계산 (새 할 일용)
        function calculateNextDate(cycle) {
            const today = new Date();
            let nextDate = new Date(today);

            // 커스텀 주기 처리
            if (cycle && cycle.includes('custom_days_')) {
                const days = parseInt(cycle.split('_')[2]);
                nextDate.setDate(nextDate.getDate() + days);
            } else if (cycle && cycle.includes('custom_weeks_')) {
                const weeks = parseInt(cycle.split('_')[2]);
                nextDate.setDate(nextDate.getDate() + (weeks * 7));
            } else {
                switch(cycle) {
                    case 'daily':
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        nextDate.setMonth(nextDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                        break;
                    default:
                        nextDate.setDate(nextDate.getDate() + 1);
                }
            }

            return nextDate.toISOString().split('T')[0];
        }

        // 가족 초대 처리
        function handleInvite(event) {
            event.preventDefault();
            
            const phone = document.getElementById('invitePhone').value;
            const nickname = document.getElementById('inviteNickname').value;
            
            // 실제로는 서버에 초대 요청을 보내야 함
            alert(`${nickname}님에게 초대 메시지가 전송되었습니다!\n(${phone})`);
            
            document.getElementById('inviteForm').reset();
            closeModal('inviteModal');
        }

        // 알람 설정 처리
        function handleAlarmSetting(event) {
            event.preventDefault();
            
            const time = document.getElementById('alarmTime').value;
            const days = Array.from(document.querySelectorAll('#alarmForm input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            alert(`알람이 설정되었습니다!\n시간: ${time}\n요일: ${days.join(', ')}`);
            
            document.getElementById('alarmForm').reset();
            closeModal('alarmModal');
        }

        // 할 일 수정
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newName = prompt('할 일 이름을 수정하세요:', task.name);
            if (newName && newName !== task.name) {
                task.name = newName;
                loadAllTasks();
                alert('할 일이 수정되었습니다!');
            }
        }

        // 템플릿 데이터 정의 (README 기반)
        const templateTasks = {
            daily: [
                '설거지', '바닥청소', '침구정리', '빨래', '음식물쓰레기', 
                '부엌 개수대', '화장실 수채구멍', '밥하기', '반찬하기'
            ],
            weekly: [
                '장보기', '화장실청소(변기, 바닥, 세면대)', '분리수거', '쓰레기버리기', 
                '정수기 관리', '비우기첼린지'
            ],
            monthly: [
                '현관', '베란다', '방향제 관리', '가구먼지제거', '베게이불세탁', 
                '스텐그릇/냄비 관리', '전자레인지/토스트기 관리', '에어후라이기 관리', 
                '인덕션/가스렌지 관리', '세탁기 통세탁', '음식물쓰레기관리', 
                '에어컨필터 물세척', '공기청정기 필터 물세척', '가습기 청소'
            ],
            quarterly: [
                '침구변경', '운동화/신발', '청소기통 비우기/로봇청소기 관리', '식기세척기관리', 
                '주방후트청소', '운동화/신발 빨래', '샤워기/세면대/주방수전/비대 필터교체', 
                '정수기필터 교체 및 외부세척'
            ],
            yearly: [
                '크리스마스 트리 넣기 (1월)', '겨울옷 넣고 반팔옷 꺼내기(4월)', 
                '커튼빨래(4월)', '차 와이퍼 교체 (5월)', '선풍기꺼내기 (5월)', 
                '옷장 신발장 제습제(6월)', '모기장 설치 (8월)', '선풍기넣기 (9월)', 
                '여름옷 정리, 긴팔 외투 꺼내기(9월)', '전기장판/난방기 꺼내기 (10월)', 
                '차 에어컨필터 (10월 초)'
            ]
        };

        // 템플릿 할 일 로드
        function loadTemplateTasks() {
            const cycle = document.getElementById('templateCycle').value;
            const taskList = document.getElementById('templateTaskList');
            
            if (!cycle) {
                taskList.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">주기를 선택해주세요</p>';
                return;
            }
            
            const tasks = templateTasks[cycle] || [];
            taskList.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.style.cssText = 'display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;';
                
                taskItem.innerHTML = `
                    <input type="checkbox" id="template_${index}" value="${task}" style="margin-right: 10px;">
                    <label for="template_${index}" style="flex: 1; cursor: pointer;">${task}</label>
                `;
                
                taskList.appendChild(taskItem);
            });
        }

        // 템플릿 추가 처리
        async function handleTemplateAdd(event) {
            event.preventDefault();
            
            const cycle = document.getElementById('templateCycle').value;
            const selectedTasks = Array.from(document.querySelectorAll('#templateTaskList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedTasks.length === 0) {
                alert('추가할 할 일을 선택해주세요.');
                return;
            }
            
            try {
                const userInfo = await callGAS('getUserInfo', { userId: currentUser.id });
                const familyMember = await callGAS('getFamilyMemberByUserId', { userId: currentUser.id });
                
                let addedCount = 0;
                for (const taskName of selectedTasks) {
                    const newTaskData = {
                        task_name: taskName,
                        category: getCategoryFromTaskName(taskName),
                        choregroup_name: getCategoryFromTaskName(taskName),
                        cycle: cycle,
                        assignee_id: familyMember ? familyMember.id_infamily : currentUser.id,
                        family_id: userInfo.family_id,
                        status: 'todo',
                        priority: 'gray',
                        freq_type: cycle === 'daily' ? 'day' : 'week',
                        freq_value: cycle === 'daily' ? 1 : (cycle === 'weekly' ? 1 : (cycle === 'monthly' ? 4 : (cycle === 'quarterly' ? 12 : 52)))
                    };
                    
                    await callGAS('addTask', newTaskData);
                    addedCount++;
                }
                
                // 할 일 목록 새로고침
                await loadTasks();
                
                // 폼 초기화
                document.getElementById('templateForm').reset();
                closeModal('templateModal');
                
                // UI 업데이트
                loadTodayTasks();
                loadAllTasks();
                
                alert(`${addedCount}개의 할 일이 추가되었습니다!`);
            } catch (error) {
                console.error('템플릿 추가 오류:', error);
                alert('템플릿 추가 중 오류가 발생했습니다.');
            }
        }

        // 할 일 이름에서 카테고리 추출
        function getCategoryFromTaskName(taskName) {
            if (taskName.includes('설거지') || taskName.includes('부엌') || taskName.includes('밥') || taskName.includes('반찬')) {
                return '주방';
            } else if (taskName.includes('바닥') || taskName.includes('거실')) {
                return '거실';
            } else if (taskName.includes('화장실') || taskName.includes('샤워기') || taskName.includes('세면대')) {
                return '화장실';
            } else if (taskName.includes('베란다')) {
                return '베란다';
            } else if (taskName.includes('침구') || taskName.includes('베개') || taskName.includes('이불')) {
                return '안방';
            } else if (taskName.includes('차') || taskName.includes('와이퍼') || taskName.includes('에어컨')) {
                return '자동차';
            } else if (taskName.includes('옷') || taskName.includes('커튼') || taskName.includes('모기장')) {
                return '계절';
            } else {
                return '기타';
            }
        }

        // Google OAuth 설정
        const GOOGLE_CLIENT_ID = '376793805883-8ub45glt9dd098ggkl3uhqjc14gn60k2.apps.googleusercontent.com'; // Google API 키 (OAuth 클라이언트 ID 필요)
        
        // Google Sign-In 초기화
        function initializeGoogleSignIn() {
            console.log('Google Sign-In 초기화 시도...');
            console.log('클라이언트 ID:', GOOGLE_CLIENT_ID);
            
            if (typeof google !== 'undefined' && google.accounts) {
                try {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleGoogleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true
                    });
                    console.log('✅ Google Sign-In 초기화 완료');
                } catch (error) {
                    console.error('❌ Google Sign-In 초기화 실패:', error);
                }
            } else {
                console.warn('⚠️ Google API가 아직 로드되지 않음. 1초 후 재시도...');
                setTimeout(initializeGoogleSignIn, 1000);
            }
        }

        // OAuth 로그인 함수들
        function loginWithGoogle() {
            console.log('🔵 Google 로그인 버튼 클릭됨');
            console.log('클라이언트 ID:', GOOGLE_CLIENT_ID);
            
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('❌ Google API가 로드되지 않음:', typeof google);
                alert('Google Sign-In API가 로드되지 않았습니다.\n\n해결 방법:\n1. 페이지를 새로고침하고 1-2초 대기\n2. 인터넷 연결 확인\n3. 브라우저 캐시 삭제');
                return;
            }

            console.log('✅ Google API 로드 확인됨');
            console.log('🚀 팝업 로그인 시도 중...');

            // One Tap 대신 직접 팝업 방식 사용
            try {
                showGoogleLoginPopup();
            } catch (error) {
                console.error('❌ Google 로그인 오류:', error);
                alert('Google 로그인 중 오류가 발생했습니다.\n\n오류: ' + error.message + '\n\n브라우저 콘솔(F12)을 확인해주세요.');
            }
        }

        // Google 로그인 팝업 표시
        function showGoogleLoginPopup() {
            console.log('🔓 OAuth 팝업 클라이언트 초기화 중...');
            
            try {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'openid email profile',
                    callback: async (tokenResponse) => {
                        console.log('✅ 토큰 응답 수신:', tokenResponse);
                        
                        if (tokenResponse.error) {
                            console.error('❌ 토큰 오류:', tokenResponse.error);
                            alert('로그인 중 오류: ' + tokenResponse.error);
                            return;
                        }
                        
                        if (tokenResponse.access_token) {
                            console.log('✅ 액세스 토큰 획득, 사용자 정보 요청 중...');
                            await getUserInfoFromGoogle(tokenResponse.access_token);
                        }
                    },
                });
                
                console.log('🚀 팝업 열기 요청...');
                client.requestAccessToken();
            } catch (error) {
                console.error('❌ 팝업 초기화 오류:', error);
                alert('팝업 초기화 실패: ' + error.message);
            }
        }

        // Google 크레덴셜 응답 처리 (One Tap 또는 버튼 클릭)
        async function handleGoogleCredentialResponse(response) {
            console.log('✅ Google 크레덴셜 수신:', response);
            
            try {
                // JWT 토큰 디코딩
                const payload = parseJwt(response.credential);
                console.log('✅ JWT 파싱 완료:', payload);
                
                const userData = {
                    provider: 'google',
                    email: payload.email,
                    name: payload.name,
                    picture: payload.picture,
                    id_token: response.credential,
                    google_id: payload.sub
                };

                console.log('사용자 데이터 준비:', userData);
                await processOAuthLogin(userData);
            } catch (error) {
                console.error('❌ Google 로그인 처리 오류:', error);
                alert('로그인 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // Google 사용자 정보 가져오기 (액세스 토큰 사용)
        async function getUserInfoFromGoogle(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('사용자 정보를 가져올 수 없습니다.');
                }

                const userInfo = await response.json();
                
                const userData = {
                    provider: 'google',
                    email: userInfo.email,
                    name: userInfo.name,
                    picture: userInfo.picture,
                    id_token: accessToken,
                    google_id: userInfo.id
                };

                await processOAuthLogin(userData);
            } catch (error) {
                console.error('Google 사용자 정보 가져오기 오류:', error);
                alert('사용자 정보를 가져오는 중 오류가 발생했습니다.');
            }
        }

        // JWT 토큰 파싱
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('JWT 파싱 오류:', error);
                return null;
            }
        }

        function loginWithApple() {
            // Apple Sign In 설정
            const clientId = 'YOUR_APPLE_CLIENT_ID'; // 실제 클라이언트 ID로 변경 필요
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'name email';
            
            const authUrl = `https://appleid.apple.com/auth/authorize?` +
                `client_id=${clientId}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=code&` +
                `scope=${encodeURIComponent(scope)}&` +
                `response_mode=form_post`;
            
            // Apple 로그인은 새 창으로 리다이렉트
            window.location.href = authUrl;
        }

        // OAuth 로그인 처리 (통합)
        async function processOAuthLogin(userData) {
            try {
                // 로딩 표시
                console.log('로그인 처리 중...', userData);

                // 서버에 사용자 정보 저장/업데이트
                const response = await callGAS('oauthLogin', {
                    provider: userData.provider,
                    email: userData.email,
                    name: userData.name,
                    picture: userData.picture,
                    id_token: userData.id_token,
                    google_id: userData.google_id
                });

                if (response && response.id) {
                    // 로컬 스토리지에 로그인 정보 저장
                    currentUser = {
                        id: response.id,
                        name: response.name,
                        nickname: response.nickname || '나',
                        familyGroup: response.familyGroup || '내 가족',
                        shellCount: response.shellCount || 0,
                        email: response.email,
                        picture: response.picture,
                        provider: userData.provider
                    };
                    
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // 메인 앱으로 이동
                    showMainApp();
                    alert(`환영합니다, ${currentUser.name}님!`);
                } else {
                    alert('로그인 처리 중 오류가 발생했습니다: ' + response.message);
                }
            } catch (error) {
                console.error('OAuth 로그인 오류:', error);
                alert('로그인 중 오류가 발생했습니다.');
            }
        }

        // URL에서 OAuth 콜백 처리
        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                alert('로그인에 실패했습니다: ' + error);
                return;
            }

            if (code) {
                // Google OAuth 콜백 처리
                handleGoogleCallback(code);
            }
        }

        // Google OAuth 콜백 처리
        async function handleGoogleCallback(code) {
            try {
                const response = await callGAS('googleOAuthCallback', {
                    code: code,
                    redirect_uri: window.location.origin + window.location.pathname
                });

                if (response.success) {
                    handleOAuthSuccess(response.user);
                } else {
                    alert('Google 로그인에 실패했습니다: ' + response.message);
                }
            } catch (error) {
                console.error('Google OAuth 콜백 오류:', error);
                alert('로그인 처리 중 오류가 발생했습니다.');
            }
        }

        // 이메일 로그인 처리 (미구현 - 현재는 OAuth만 지원)
        function handleLogin(event) {
            event.preventDefault();
            console.log('이메일 로그인 시도');
            alert('현재는 Google 또는 Apple 로그인만 지원합니다.');
            closeModal('authModal');
        }

        // 회원가입 처리 (미구현 - 현재는 OAuth만 지원)
        function handleSignup(event) {
            event.preventDefault();
            console.log('회원가입 시도');
            alert('현재는 Google 또는 Apple 로그인만 지원합니다.\n로그인 시 자동으로 계정이 생성됩니다.');
            closeModal('authModal');
        }

        // 모달 열기 함수들
        function openLoginModal() {
            document.getElementById('authModal').classList.add('active');
            switchAuthTab('login');
        }

        function openSignupModal() {
            document.getElementById('authModal').classList.add('active');
            switchAuthTab('signup');
        }

        // 인증 탭 전환
        function switchAuthTab(tab) {
            // 탭 버튼 활성화 상태 변경
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
        }

        // 로그아웃
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUser');
            currentUser = {
                id: 'USER001',
                name: '사용자',
                nickname: '닉네임',
                familyGroup: '우리가족',
                shellCount: 0
            };
            showLandingPage();
            alert('로그아웃되었습니다.');
        }

        // 모달 외부 클릭 시 닫기
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
